<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä½“èª¿å ±å‘Šã‚¢ãƒ—ãƒª</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/supabase-js/2.39.0/umd/supabase.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #ffffff;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }

        .app-title {
            font-size: 24px;
            font-weight: 500;
            margin-bottom: 10px;
        }

        .user-selection {
            margin-bottom: 20px;
            text-align: center;
        }

        .user-btn {
            padding: 10px 20px;
            margin: 0 10px;
            border: 1px solid #333;
            background: white;
            cursor: pointer;
            font-size: 16px;
        }

        .user-btn.active {
            background: #333;
            color: white;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .nav-btn {
            padding: 10px 20px;
            border: 1px solid #333;
            background: white;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s;
        }

        .nav-btn.active {
            background: #333;
            color: white;
        }

        .nav-btn:hover {
            background: #f5f5f5;
        }

        .nav-btn.active:hover {
            background: #555;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .form-group {
            margin-bottom: 30px;
        }

        .form-label {
            display: block;
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .scale-buttons {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-bottom: 10px;
        }

        .scale-btn {
            padding: 15px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            font-size: 16px;
            text-align: center;
            transition: all 0.2s;
        }

        .scale-btn:hover {
            border-color: #333;
        }

        .scale-btn.selected {
            background: #333 !important;
            color: white !important;
            border-color: #333 !important;
        }

        .scale-legend {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .symptom-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .symptom-btn {
            padding: 15px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            font-size: 14px;
            text-align: center;
            transition: all 0.2s;
        }

        .symptom-btn:hover {
            border-color: #333;
        }

        .symptom-btn.selected {
            background: #333 !important;
            color: white !important;
            border-color: #333 !important;
        }

        .activity-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .activity-btn {
            padding: 20px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            font-size: 16px;
            text-align: left;
            transition: all 0.2s;
        }

        .activity-btn:hover {
            border-color: #333;
        }

        .activity-btn.selected {
            background: #333 !important;
            color: white !important;
            border-color: #333 !important;
        }

        .activity-btn.emergency {
            border-color: #dc3545;
            color: #dc3545;
        }

        .activity-btn.emergency.selected {
            background: #dc3545;
            color: white;
        }

        .submit-btn {
            width: 100%;
            padding: 20px;
            background: #333;
            color: white;
            border: none;
            font-size: 18px;
            cursor: pointer;
            margin-top: 30px;
            transition: all 0.2s;
        }

        .submit-btn:hover {
            background: #555;
        }

        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .reports-list {
            border: 1px solid #ddd;
        }

        .report-item {
            padding: 20px;
            border-bottom: 1px solid #eee;
        }

        .report-item:last-child {
            border-bottom: none;
        }

        .report-item.emergency {
            background: #fff5f5;
            border-left: 4px solid #dc3545;
        }

        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .report-date {
            font-size: 14px;
            color: #666;
        }

        .emergency-badge {
            background: #dc3545;
            color: white;
            padding: 4px 8px;
            font-size: 12px;
            border-radius: 3px;
        }

        .report-content {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 15px;
        }

        .condition-item {
            text-align: center;
        }

        .condition-name {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .condition-value {
            font-size: 24px;
            font-weight: bold;
        }

        .report-details {
            font-size: 14px;
            color: #666;
        }

        .no-reports {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .notification-setup {
            background: #f8f9fa;
            border: 1px solid #ddd;
            padding: 20px;
            margin-bottom: 20px;
        }

        .notification-btn {
            width: 100%;
            padding: 15px;
            background: #007bff;
            color: white;
            border: none;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
        }

        .notification-btn:hover {
            background: #0056b3;
        }

        .notification-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            color: #721c24;
        }

        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            color: #155724;
        }

        .refresh-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .refresh-btn:hover {
            background: #0056b3;
        }

        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }

            .scale-buttons {
                grid-template-columns: repeat(5, 1fr);
                gap: 5px;
            }

            .scale-btn {
                padding: 12px 8px;
                font-size: 14px;
            }

            .symptom-grid {
                grid-template-columns: 1fr;
            }

            .report-content {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .user-btn {
                margin: 5px;
                padding: 8px 16px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="app-title">ä½“èª¿å ±å‘Š</h1>
            
            <div class="user-selection">
                <div style="margin-bottom: 10px; font-size: 14px; color: #666;">åˆ©ç”¨è€…ã‚’é¸æŠï¼š</div>
                <button class="user-btn" onclick="setUser('reporter')" id="reporter-btn">å ±å‘Šè€…</button>
                <button class="user-btn" onclick="setUser('viewer')" id="viewer-btn">ç¢ºèªè€…ï¼ˆå¥¥æ§˜ï¼‰</button>
            </div>

            <div class="nav-buttons" id="nav-buttons" style="display: none;">
                <button class="nav-btn active" onclick="showSection('report')" id="report-nav">å ±å‘Šã™ã‚‹</button>
                <button class="nav-btn" onclick="showSection('history')" id="history-nav">å±¥æ­´ã‚’è¦‹ã‚‹</button>
            </div>
        </div>

        <div id="loading" class="loading" style="display: none;">
            èª­ã¿è¾¼ã¿ä¸­...
        </div>

        <div id="error-message" class="error" style="display: none;"></div>
        <div id="success-message" class="success" style="display: none;"></div>

        <!-- å ±å‘Šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="report-section" class="section">
            <form id="health-form">
                <div class="form-group">
                    <label class="form-label">ã‚¯ãƒ­ãƒ¼ãƒ³ç—…ã®çŠ¶æ…‹</label>
                    <div class="scale-buttons" data-field="crohn">
                        <button type="button" class="scale-btn" data-value="1">1</button>
                        <button type="button" class="scale-btn" data-value="2">2</button>
                        <button type="button" class="scale-btn" data-value="3">3</button>
                        <button type="button" class="scale-btn" data-value="4">4</button>
                        <button type="button" class="scale-btn" data-value="5">5</button>
                        <button type="button" class="scale-btn" data-value="6">6</button>
                        <button type="button" class="scale-btn" data-value="7">7</button>
                        <button type="button" class="scale-btn" data-value="8">8</button>
                        <button type="button" class="scale-btn" data-value="9">9</button>
                        <button type="button" class="scale-btn" data-value="10">10</button>
                    </div>
                    <div class="scale-legend">
                        <span>è»½åº¦</span>
                        <span>é‡åº¦</span>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">é‡ç—‡ç­‹ç„¡åŠ›ç—‡ã®çŠ¶æ…‹</label>
                    <div class="scale-buttons" data-field="myasthenia">
                        <button type="button" class="scale-btn" data-value="1">1</button>
                        <button type="button" class="scale-btn" data-value="2">2</button>
                        <button type="button" class="scale-btn" data-value="3">3</button>
                        <button type="button" class="scale-btn" data-value="4">4</button>
                        <button type="button" class="scale-btn" data-value="5">5</button>
                        <button type="button" class="scale-btn" data-value="6">6</button>
                        <button type="button" class="scale-btn" data-value="7">7</button>
                        <button type="button" class="scale-btn" data-value="8">8</button>
                        <button type="button" class="scale-btn" data-value="9">9</button>
                        <button type="button" class="scale-btn" data-value="10">10</button>
                    </div>
                    <div class="scale-legend">
                        <span>è»½åº¦</span>
                        <span>é‡åº¦</span>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">ç·šç¶­ç­‹ç—›ç—‡ã®çŠ¶æ…‹</label>
                    <div class="scale-buttons" data-field="fibromyalgia">
                        <button type="button" class="scale-btn" data-value="1">1</button>
                        <button type="button" class="scale-btn" data-value="2">2</button>
                        <button type="button" class="scale-btn" data-value="3">3</button>
                        <button type="button" class="scale-btn" data-value="4">4</button>
                        <button type="button" class="scale-btn" data-value="5">5</button>
                        <button type="button" class="scale-btn" data-value="6">6</button>
                        <button type="button" class="scale-btn" data-value="7">7</button>
                        <button type="button" class="scale-btn" data-value="8">8</button>
                        <button type="button" class="scale-btn" data-value="9">9</button>
                        <button type="button" class="scale-btn" data-value="10">10</button>
                    </div>
                    <div class="scale-legend">
                        <span>è»½åº¦</span>
                        <span>é‡åº¦</span>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">ç‰¹ã«æ°—ã«ãªã‚‹ç—‡çŠ¶ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
                    <div class="symptom-grid" data-field="symptoms">
                        <button type="button" class="symptom-btn" data-value="abdominal_pain">è…¹ç—›</button>
                        <button type="button" class="symptom-btn" data-value="diarrhea">ä¸‹ç—¢</button>
                        <button type="button" class="symptom-btn" data-value="loss_of_appetite">é£Ÿæ¬²ä¸æŒ¯</button>
                        <button type="button" class="symptom-btn" data-value="general_weakness">å…¨èº«è„±åŠ›</button>
                        <button type="button" class="symptom-btn" data-value="localized_weakness">éƒ¨åˆ†çš„è„±åŠ›</button>
                        <button type="button" class="symptom-btn" data-value="general_pain">å…¨èº«ç—›</button>
                        <button type="button" class="symptom-btn" data-value="localized_pain">éƒ¨åˆ†çš„ç—›ã¿</button>
                        <button type="button" class="symptom-btn" data-value="fatigue">å¼·ã„ç–²åŠ´æ„Ÿ</button>
                        <button type="button" class="symptom-btn" data-value="other" id="other-symptom-btn">ãã®ä»–</button>
                    </div>
                    <div id="other-symptom-input" style="display: none; margin-top: 15px;">
                        <input type="text" id="other-symptom-text" placeholder="ç—‡çŠ¶ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" style="width: 100%; padding: 15px; border: 1px solid #ddd; font-size: 16px;">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">ä»Šæ—¥ã®æ´»å‹•ãƒ¬ãƒ™ãƒ«</label>
                    <div class="activity-buttons" data-field="activity">
                        <button type="button" class="activity-btn" data-value="excellent">ğŸ›’ å¤–å‡ºãƒ»è²·ã„ç‰©å¯èƒ½</button>
                        <button type="button" class="activity-btn" data-value="good">ğŸ  å®¶äº‹ã¯å¯èƒ½</button>
                        <button type="button" class="activity-btn" data-value="moderate">ğŸª‘ åº§ã£ã¦ã„ã‚Œã°å¤§ä¸ˆå¤«</button>
                        <button type="button" class="activity-btn" data-value="rest">ğŸ›ï¸ æ¨ªã«ãªã£ã¦ã„ãŸã„</button>
                        <button type="button" class="activity-btn emergency" data-value="emergency">ğŸš¨ éå¸¸ã«è¾›ã„</button>
                    </div>
                </div>

                <button type="submit" class="submit-btn">å ±å‘Šã‚’é€ä¿¡</button>
            </form>
        </div>

        <!-- å±¥æ­´ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="history-section" class="section">
            <div class="notification-setup">
                <h3>é€šçŸ¥è¨­å®š</h3>
                <p>æ–°ã—ã„å ±å‘ŠãŒå±Šã„ãŸã¨ãã«é€šçŸ¥ã‚’å—ã‘å–ã‚Œã¾ã™</p>
                <button class="notification-btn" onclick="requestNotificationPermission()">é€šçŸ¥ã‚’æœ‰åŠ¹ã«ã™ã‚‹</button>
            </div>
            
            <div id="reports-container">
                <div class="no-reports">ã¾ã å ±å‘ŠãŒã‚ã‚Šã¾ã›ã‚“</div>
            </div>
        </div>
    </div>

    <button class="refresh-btn" onclick="loadReports()" title="æ›´æ–°">ğŸ”„</button>

    <script>
        // Supabaseè¨­å®šï¼ˆã“ã®éƒ¨åˆ†ã¯å¾Œã§å®Ÿéš›ã®å€¤ã«ç½®ãæ›ãˆã¾ã™ï¼‰
        const SUPABASE_URL = 'YOUR_SUPABASE_URL';
        const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';
        let supabase;
        
        // ã‚¢ãƒ—ãƒªã®çŠ¶æ…‹ç®¡ç†
        let currentUser = null;
        let currentFormData = {
            crohn: null,
            myasthenia: null,
            fibromyalgia: null,
            symptoms: [],
            otherSymptom: '',
            activity: null
        };

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeSupabase();
            setupEventListeners();
        });

        // SupabaseåˆæœŸåŒ–
        function initializeSupabase() {
            if (SUPABASE_URL !== 'YOUR_SUPABASE_URL') {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            }
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š
        function setUser(userType) {
            currentUser = userType;
            
            // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
            document.querySelectorAll('.user-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(userType + '-btn').classList.add('active');
            
            // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã®è¡¨ç¤º
            document.getElementById('nav-buttons').style.display = 'flex';
            
            // é©åˆ‡ãªã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
            if (userType === 'reporter') {
                showSection('report');
            } else {
                showSection('history');
                loadReports();
            }
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
        function setupEventListeners() {
            // ã‚¹ã‚±ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
            document.querySelectorAll('.scale-buttons .scale-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const field = this.closest('.scale-buttons').dataset.field;
                    const value = parseInt(this.dataset.value);
                    
                    // åŒã˜ã‚°ãƒ«ãƒ¼ãƒ—ã®ä»–ã®ãƒœã‚¿ãƒ³ã®é¸æŠã‚’è§£é™¤
                    this.closest('.scale-buttons').querySelectorAll('.scale-btn').forEach(b => {
                        b.classList.remove('selected');
                    });
                    
                    // ç¾åœ¨ã®ãƒœã‚¿ãƒ³ã‚’é¸æŠ
                    this.classList.add('selected');
                    currentFormData[field] = value;
                    
                    console.log(`${field} selected:`, value); // ãƒ‡ãƒãƒƒã‚°ç”¨
                });
            });

            // ç—‡çŠ¶ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
            document.querySelectorAll('.symptom-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const value = this.dataset.value;
                    
                    if (value === 'other') {
                        // ãã®ä»–ã®ç—‡çŠ¶ã®å‡¦ç†
                        const inputDiv = document.getElementById('other-symptom-input');
                        if (this.classList.contains('selected')) {
                            // é¸æŠè§£é™¤
                            this.classList.remove('selected');
                            inputDiv.style.display = 'none';
                            currentFormData.symptoms = currentFormData.symptoms.filter(s => s !== 'other');
                            currentFormData.otherSymptom = '';
                            document.getElementById('other-symptom-text').value = '';
                        } else {
                            // é¸æŠ
                            this.classList.add('selected');
                            inputDiv.style.display = 'block';
                            if (!currentFormData.symptoms.includes('other')) {
                                currentFormData.symptoms.push('other');
                            }
                            document.getElementById('other-symptom-text').focus();
                        }
                    } else {
                        if (this.classList.contains('selected')) {
                            // é¸æŠè§£é™¤
                            this.classList.remove('selected');
                            currentFormData.symptoms = currentFormData.symptoms.filter(s => s !== value);
                        } else {
                            // é¸æŠ
                            this.classList.add('selected');
                            if (!currentFormData.symptoms.includes(value)) {
                                currentFormData.symptoms.push(value);
                            }
                        }
                    }
                    
                    console.log('Symptoms selected:', currentFormData.symptoms); // ãƒ‡ãƒãƒƒã‚°ç”¨
                });
            });

            // ãã®ä»–ã®ç—‡çŠ¶å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã‚¤ãƒ™ãƒ³ãƒˆ
            document.getElementById('other-symptom-text').addEventListener('input', function() {
                currentFormData.otherSymptom = this.value;
            });

            // æ´»å‹•ãƒ¬ãƒ™ãƒ«ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
            document.querySelectorAll('.activity-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const value = this.dataset.value;
                    
                    // åŒã˜ã‚°ãƒ«ãƒ¼ãƒ—ã®ä»–ã®ãƒœã‚¿ãƒ³ã®é¸æŠã‚’è§£é™¤
                    this.closest('.activity-buttons').querySelectorAll('.activity-btn').forEach(b => {
                        b.classList.remove('selected');
                    });
                    
                    // ç¾åœ¨ã®ãƒœã‚¿ãƒ³ã‚’é¸æŠ
                    this.classList.add('selected');
                    currentFormData.activity = value;
                    
                    console.log('Activity selected:', value); // ãƒ‡ãƒãƒƒã‚°ç”¨
                });
            });

            // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã®ã‚¤ãƒ™ãƒ³ãƒˆ
            document.getElementById('health-form').addEventListener('submit', function(e) {
                e.preventDefault();
                submitReport();
            });
        }

        // ã‚»ã‚¯ã‚·ãƒ§ãƒ³åˆ‡ã‚Šæ›¿ãˆ
        function showSection(sectionName) {
            // ãƒŠãƒ“ãƒœã‚¿ãƒ³ã®æ›´æ–°
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(sectionName + '-nav').classList.add('active');

            // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionName + '-section').classList.add('active');

            if (sectionName === 'history') {
                loadReports();
            }
        }

        // å ±å‘Šã®é€ä¿¡
        async function submitReport() {
            // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            if (!currentFormData.crohn || !currentFormData.myasthenia || !currentFormData.fibromyalgia || !currentFormData.activity) {
                showError('ã™ã¹ã¦ã®é …ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            // ãã®ä»–ã®ç—‡çŠ¶ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹ãŒå…¥åŠ›ã•ã‚Œã¦ã„ãªã„å ´åˆ
            if (currentFormData.symptoms.includes('other') && !currentFormData.otherSymptom.trim()) {
                showError('ãã®ä»–ã®ç—‡çŠ¶ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            showLoading(true);

            try {
                // ãƒ¬ãƒãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã®ä½œæˆ
                const report = {
                    timestamp: new Date().toISOString(),
                    crohn: currentFormData.crohn,
                    myasthenia: currentFormData.myasthenia,
                    fibromyalgia: currentFormData.fibromyalgia,
                    symptoms: currentFormData.symptoms,
                    other_symptom: currentFormData.otherSymptom,
                    activity: currentFormData.activity,
                    is_emergency: currentFormData.activity === 'emergency'
                };

                if (supabase) {
                    // Supabaseã«ä¿å­˜
                    const { data, error } = await supabase
                        .from('health_reports')
                        .insert([report]);

                    if (error) throw error;
                } else {
                    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
                    const reports = getStoredReports();
                    report.id = Date.now();
                    reports.unshift(report);
                    localStorage.setItem('health_reports', JSON.stringify(reports));
                }

                // é€šçŸ¥ã®é€ä¿¡
                if (currentFormData.activity === 'emergency') {
                    sendNotification('ğŸš¨ ç·Šæ€¥å ±å‘Š', 'ç·Šæ€¥ã®ä½“èª¿å ±å‘ŠãŒå±Šãã¾ã—ãŸ');
                } else {
                    sendNotification('ğŸ“Š ä½“èª¿å ±å‘Š', 'æ–°ã—ã„ä½“èª¿å ±å‘ŠãŒå±Šãã¾ã—ãŸ');
                }

                // ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒªã‚»ãƒƒãƒˆ
                resetForm();
                
                showSuccess('å ±å‘Šã‚’é€ä¿¡ã—ã¾ã—ãŸ');
                
                // å±¥æ­´ç”»é¢ã«åˆ‡ã‚Šæ›¿ãˆ
                setTimeout(() => {
                    showSection('history');
                }, 1500);

            } catch (error) {
                console.error('Error submitting report:', error);
                showError('å ±å‘Šã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
            } finally {
                showLoading(false);
            }
        }

        // ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒªã‚»ãƒƒãƒˆ
        function resetForm() {
            currentFormData = {
                crohn: null,
                myasthenia: null,
                fibromyalgia: null,
                symptoms: [],
                otherSymptom: '',
                activity: null
            };

            document.querySelectorAll('.selected').forEach(btn => {
                btn.classList.remove('selected');
            });

            // ãã®ä»–ã®ç—‡çŠ¶å…¥åŠ›ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('other-symptom-input').style.display = 'none';
            document.getElementById('other-symptom-text').value = '';
        }

        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰å ±å‘Šã‚’å–å¾—
        function getStoredReports() {
            const stored = localStorage.getItem('health_reports');
            return stored ? JSON.parse(stored) : [];
        }

        // å ±å‘Šå±¥æ­´ã®èª­ã¿è¾¼ã¿
        async function loadReports() {
            showLoading(true);

            try {
                let reports = [];

                if (supabase) {
                    // Supabaseã‹ã‚‰å–å¾—
                    const { data, error } = await supabase
                        .from('health_reports')
                        .select('*')
                        .order('timestamp', { ascending: false });

                    if (error) throw error;
                    reports = data || [];
                } else {
                    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰å–å¾—
                    reports = getStoredReports();
                }

                displayReports(reports);

            } catch (error) {
                console.error('Error loading reports:', error);
                showError('å ±å‘Šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰èª­ã¿è¾¼ã¿
                displayReports(getStoredReports());
            } finally {
                showLoading(false);
            }
        }

        // å ±å‘Šã®è¡¨ç¤º
        function displayReports(reports) {
            const container = document.getElementById('reports-container');

            if (reports.length === 0) {
                container.innerHTML = '<div class="no-reports">ã¾ã å ±å‘ŠãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            const symptomsLabels = {
                'abdominal_pain': 'è…¹ç—›',
                'diarrhea': 'ä¸‹ç—¢',
                'loss_of_appetite': 'é£Ÿæ¬²ä¸æŒ¯',
                'general_weakness': 'å…¨èº«è„±åŠ›',
                'localized_weakness': 'éƒ¨åˆ†çš„è„±åŠ›',
                'general_pain': 'å…¨èº«ç—›',
                'localized_pain': 'éƒ¨åˆ†çš„ç—›ã¿',
                'fatigue': 'å¼·ã„ç–²åŠ´æ„Ÿ',
                'other': 'ãã®ä»–'
            };

            const activityLabels = {
                'excellent': 'ğŸ›’ å¤–å‡ºãƒ»è²·ã„ç‰©å¯èƒ½',
                'good': 'ğŸ  å®¶äº‹ã¯å¯èƒ½',
                'moderate': 'ğŸª‘ åº§ã£ã¦ã„ã‚Œã°å¤§ä¸ˆå¤«',
                'rest': 'ğŸ›ï¸ æ¨ªã«ãªã£ã¦ã„ãŸã„',
                'emergency': 'ğŸš¨ éå¸¸ã«è¾›ã„'
            };

            const html = reports.map(report => {
                const date = new Date(report.timestamp);
                let symptoms = [];
                
                if (report.symptoms && report.symptoms.length > 0) {
                    symptoms = report.symptoms.map(s => {
                        if (s === 'other' && report.other_symptom) {
                            return `ãã®ä»–(${report.other_symptom})`;
                        }
                        return symptomsLabels[s] || s;
                    });
                }
                
                const symptomsText = symptoms.length > 0 ? symptoms.join(', ') : 'ãªã—';
                
                return `
                    <div class="report-item ${report.activity === 'emergency' ? 'emergency' : ''}">
                        <div class="report-header">
                            <div class="report-date">
                                ${date.toLocaleDateString('ja-JP')} ${date.toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'})}
                            </div>
                            ${report.activity === 'emergency' ? '<span class="emergency-badge">ç·Šæ€¥</span>' : ''}
                        </div>
                        <div class="report-content">
                            <div class="condition-item">
                                <div class="condition-name">ã‚¯ãƒ­ãƒ¼ãƒ³ç—…</div>
                                <div class="condition-value">${report.crohn}/10</div>
                            </div>
                            <div class="condition-item">
                                <div class="condition-name">é‡ç—‡ç­‹ç„¡åŠ›ç—‡</div>
                                <div class="condition-value">${report.myasthenia}/10</div>
                            </div>
                            <div class="condition-item">
                                <div class="condition-name">ç·šç¶­ç­‹ç—›ç—‡</div>
                                <div class="condition-value">${report.fibromyalgia}/10</div>
                            </div>
                        </div>
                        <div class="report-details">
                            <div><strong>ç—‡çŠ¶:</strong> ${symptomsText}</div>
                            <div><strong>æ´»å‹•ãƒ¬ãƒ™ãƒ«:</strong> ${activityLabels[report.activity]}</div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        // é€šçŸ¥æ¨©é™ã®è¦æ±‚
        function requestNotificationPermission() {
            if ('Notification' in window) {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        showSuccess('é€šçŸ¥ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸ');
                    } else {
                        showError('é€šçŸ¥ã®è¨±å¯ãŒå¿…è¦ã§ã™');
                    }
                });
            } else {
                showError('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯é€šçŸ¥ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“');
            }
        }

        // é€šçŸ¥ã®é€ä¿¡
        function sendNotification(title, body) {
            if ('Notification' in window && Notification.permission === 'granted') {
                const notification = new Notification(title, {
                    body: body,
                    icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiBmaWxsPSIjZmZmIiBzdHJva2U9IiMzMzMiIHN0cm9rZS13aWR0aD0iMiIvPgo8dGV4dCB4PSIzMiIgeT0iNDAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIyNCIgZmlsbD0iIzMzMyIgdGV4dC1hbmNob3I9Im1pZGRsZSI+ğŸ“ŠPC90ZXh0Pgo8L3N2Zz4K',
                    requireInteraction: title.includes('ğŸš¨'),
                    tag: 'health-report'
                });

                // é€šçŸ¥ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸæ™‚ã®å‡¦ç†
                notification.onclick = function() {
                    window.focus();
                    showSection('history');
                    notification.close();
                };

                // ç·Šæ€¥æ™‚ã¯é•·æ™‚é–“è¡¨ç¤º
                if (!title.includes('ğŸš¨')) {
                    setTimeout(() => notification.close(), 5000);
                }
            }
        }

        // UI ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯é–¢æ•°
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('success-message');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 3000);
        }

        // å®šæœŸçš„ãªæ›´æ–°ï¼ˆç¢ºèªè€…ã®å ´åˆï¼‰
        function startPeriodicRefresh() {
            if (currentUser === 'viewer') {
                setInterval(() => {
                    loadReports();
                }, 30000); // 30ç§’ã”ã¨ã«æ›´æ–°
            }
        }

        // ãƒšãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚ŒãŸã¨ãã®å‡¦ç†
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && currentUser === 'viewer') {
                loadReports();
            }
        });
    </script>
</body>
</html>
                